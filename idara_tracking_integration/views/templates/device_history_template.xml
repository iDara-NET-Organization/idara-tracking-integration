<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="device_history_template" name="Device History Viewer">
        <html>
        <head>
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
            <style>
                body {
                    margin: 0;
                    padding: 0;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: #f5f5f5;
                }
                
                .history-container {
                    display: flex;
                    flex-direction: column;
                    height: 100vh;
                }
                
                .history-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                
                .history-title {
                    font-size: 24px;
                    font-weight: 600;
                    margin: 0 0 15px 0;
                    display: flex;
                    align-items: center;
                }
                
                .controls-panel {
                    display: flex;
                    gap: 15px;
                    flex-wrap: wrap;
                    align-items: flex-end;
                }
                
                .control-group {
                    display: flex;
                    flex-direction: column;
                    gap: 5px;
                }
                
                .control-group label {
                    font-size: 12px;
                    font-weight: 500;
                    opacity: 0.9;
                }
                
                .control-group select,
                .control-group input {
                    padding: 8px 12px;
                    border: none;
                    border-radius: 5px;
                    font-size: 14px;
                    background: white;
                    color: #333;
                    min-width: 150px;
                }
                
                .btn-load {
                    padding: 8px 20px;
                    background: #4CAF50;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s;
                }
                
                .btn-load:hover {
                    background: #45a049;
                }
                
                .map-container {
                    flex: 1;
                    position: relative;
                }
                
                #history-map {
                    width: 100%;
                    height: 100%;
                }
                
                .info-panel {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    min-width: 250px;
                    z-index: 1000;
                }
                
                .info-panel h3 {
                    margin: 0 0 10px 0;
                    font-size: 16px;
                    color: #667eea;
                }
                
                .info-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 5px 0;
                    font-size: 13px;
                }
                
                .error-message {
                    background: #f44336;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    margin: 10px;
                    display: none;
                }
                
                .error-message.active {
                    display: block;
                }
                
                .loading-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255,255,255,0.9);
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                }
                
                .loading-overlay.active {
                    display: flex;
                }
                
                .spinner {
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #667eea;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        </head>
        <body>
            <div class="history-container">
                <div class="history-header">
                    <h1 class="history-title">
                        üó∫Ô∏è Device Route History
                    </h1>
                    
                    <div class="controls-panel">
                        <div class="control-group">
                            <label>Device</label>
                            <select id="device-select">
                                <option value="">Select Device...</option>
                                <t t-foreach="devices" t-as="device">
                                    <option t-att-value="device.id">
                                        <t t-esc="device.name or device.device_id"/>
                                    </option>
                                </t>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>From Date &amp; Time</label>
                            <input type="datetime-local" id="from-datetime" />
                        </div>
                        
                        <div class="control-group">
                            <label>To Date &amp; Time</label>
                            <input type="datetime-local" id="to-datetime" />
                        </div>
                        
                        <div class="control-group">
                            <button class="btn-load" onclick="loadHistory()">
                                üîç Load Route
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="error-message" id="error-message"></div>
                
                <div class="map-container">
                    <div id="history-map"></div>
                    
                    <div class="info-panel" id="info-panel" style="display: none;">
                        <h3>Route Summary</h3>
                        <div class="info-item">
                            <span>Total Distance:</span>
                            <span id="total-distance">-</span>
                        </div>
                        <div class="info-item">
                            <span>Duration:</span>
                            <span id="duration">-</span>
                        </div>
                        <div class="info-item">
                            <span>Top Speed:</span>
                            <span id="top-speed">-</span>
                        </div>
                        <div class="info-item">
                            <span>Stops:</span>
                            <span id="stops-count">-</span>
                        </div>
                        <div class="info-item">
                            <span>Points:</span>
                            <span id="points-count">-</span>
                        </div>
                    </div>
                    
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <script type="text/javascript">
            //<![CDATA[
                let map;
                let routeLine;
                let markers = [];
                
                function initMap() {
                    if (typeof L === 'undefined') {
                        console.error('Leaflet not loaded!');
                        showError('Map library not loaded. Please refresh the page.');
                        return;
                    }
                    
                    map = L.map('history-map').setView([24.7136, 46.6753], 6);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap',
                        maxZoom: 19
                    }).addTo(map);
                }
                
                function setDefaultDateTimes() {
                    const now = new Date();
                    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    
                    const formatDateTime = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
                    };
                    
                    document.getElementById('from-datetime').value = formatDateTime(yesterday);
                    document.getElementById('to-datetime').value = formatDateTime(now);
                }
                
                function showError(message) {
                    const errorDiv = document.getElementById('error-message');
                    errorDiv.textContent = message;
                    errorDiv.classList.add('active');
                    
                    setTimeout(() => {
                        errorDiv.classList.remove('active');
                    }, 5000);
                }
                
                function showLoading(show) {
                    const overlay = document.getElementById('loading-overlay');
                    if (show) {
                        overlay.classList.add('active');
                    } else {
                        overlay.classList.remove('active');
                    }
                }
                
                function clearMap() {
                    if (routeLine) {
                        map.removeLayer(routeLine);
                    }
                    
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                }
                
                function loadHistory() {
                    const deviceId = document.getElementById('device-select').value;
                    const fromDateTime = document.getElementById('from-datetime').value;
                    const toDateTime = document.getElementById('to-datetime').value;
                    
                    if (!deviceId) {
                        showError('Please select a device');
                        return;
                    }
                    
                    if (!fromDateTime || !toDateTime) {
                        showError('Please select date and time range');
                        return;
                    }
                    
                    const fromDT = fromDateTime.replace('T', ' ') + ':00';
                    const toDT = toDateTime.replace('T', ' ') + ':00';
                    
                    showLoading(true);
                    clearMap();
                    
                    fetch('/idara_tracking/get_device_history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'call',
                            params: {
                                device_id: deviceId,
                                from_datetime: fromDT,
                                to_datetime: toDT
                            },
                            id: new Date().getTime()
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        showLoading(false);
                        
                        if (!data.result) {
                            showError('No response from server');
                            return;
                        }
                        
                        const result = data.result;
                        
                        if (result.status === 'error') {
                            showError('Error: ' + result.message);
                            return;
                        }
                        
                        if (result.status === 'success') {
                            displayRoute(result.data);
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        showError('Failed to load history: ' + error.message);
                        console.error('Error:', error);
                    });
                }
                
                function displayRoute(historyData) {
                    if (!historyData || !historyData.items) {
                        showError('No route data available');
                        return;
                    }
                    
                    const routePoints = [];
                    let totalPoints = 0;
                    let stopsCount = 0;
                    
                    historyData.items.forEach(segment => {
                        if (segment.items && Array.isArray(segment.items)) {
                            segment.items.forEach(point => {
                                if (point.lat && point.lng) {
                                    routePoints.push([
                                        parseFloat(point.lat),
                                        parseFloat(point.lng)
                                    ]);
                                    totalPoints++;
                                }
                            });
                            
                            if (segment.status === 2) {
                                stopsCount++;
                            }
                        }
                    });
                    
                    if (routePoints.length === 0) {
                        showError('No GPS points found in the selected time range');
                        return;
                    }
                    
                    routeLine = L.polyline(routePoints, {
                        color: '#4285F4',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);
                    
                    const startMarker = L.marker(routePoints[0], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                    startMarker.bindPopup('<strong>Start</strong>');
                    markers.push(startMarker);
                    
                    const endMarker = L.marker(routePoints[routePoints.length - 1], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                    endMarker.bindPopup('<strong>End</strong>');
                    markers.push(endMarker);
                    
                    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                    
                    document.getElementById('total-distance').textContent = historyData.distance_sum || '-';
                    document.getElementById('duration').textContent = historyData.move_duration || '-';
                    document.getElementById('top-speed').textContent = (historyData.top_speed || '0') + ' km/h';
                    document.getElementById('stops-count').textContent = stopsCount;
                    document.getElementById('points-count').textContent = totalPoints;
                    document.getElementById('info-panel').style.display = 'block';
                }
                
                window.addEventListener('load', function() {
                    initMap();
                    setDefaultDateTimes();
                });
            //]]>
            </script>
        </body>
        </html>
    </template>
</odoo>
