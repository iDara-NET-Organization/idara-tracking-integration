<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="device_history_template" name="Device History Viewer">
        <t t-call="web.html_container">
            <t t-set="head_website">
                <script type="text/javascript" t-att-src="'https://maps.googleapis.com/maps/api/js?key=' + google_maps_key + '&amp;libraries=geometry'"></script>
                <style>
                    body {
                        margin: 0;
                        padding: 0;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        background: #f5f5f5;
                    }
                    
                    .history-container {
                        display: flex;
                        flex-direction: column;
                        height: 100vh;
                    }
                    
                    .history-header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 20px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    }
                    
                    .history-title {
                        font-size: 24px;
                        font-weight: 600;
                        margin: 0 0 15px 0;
                        display: flex;
                        align-items: center;
                    }
                    
                    .history-title i {
                        margin-right: 10px;
                        font-size: 28px;
                    }
                    
                    .controls-panel {
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                        align-items: flex-end;
                    }
                    
                    .control-group {
                        display: flex;
                        flex-direction: column;
                        gap: 5px;
                    }
                    
                    .control-group label {
                        font-size: 12px;
                        font-weight: 500;
                        opacity: 0.9;
                    }
                    
                    .control-group select,
                    .control-group input {
                        padding: 8px 12px;
                        border: none;
                        border-radius: 5px;
                        font-size: 14px;
                        background: white;
                        color: #333;
                        min-width: 150px;
                    }
                    
                    .control-group input[type="datetime-local"] {
                        min-width: 200px;
                    }
                    
                    .btn-load {
                        padding: 8px 20px;
                        background: #4CAF50;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        transition: all 0.3s;
                    }
                    
                    .btn-load:hover {
                        background: #45a049;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    }
                    
                    .btn-load:disabled {
                        background: #ccc;
                        cursor: not-allowed;
                        transform: none;
                    }
                    
                    .map-container {
                        flex: 1;
                        position: relative;
                    }
                    
                    #history-map {
                        width: 100%;
                        height: 100%;
                    }
                    
                    .info-panel {
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: white;
                        padding: 15px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        min-width: 250px;
                        max-width: 350px;
                        z-index: 100;
                    }
                    
                    .info-panel h3 {
                        margin: 0 0 10px 0;
                        font-size: 16px;
                        color: #667eea;
                        border-bottom: 2px solid #667eea;
                        padding-bottom: 5px;
                    }
                    
                    .info-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 5px 0;
                        font-size: 13px;
                        border-bottom: 1px solid #eee;
                    }
                    
                    .info-item:last-child {
                        border-bottom: none;
                    }
                    
                    .info-label {
                        font-weight: 600;
                        color: #666;
                    }
                    
                    .info-value {
                        color: #333;
                        font-weight: 500;
                    }
                    
                    .loading-overlay {
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(255,255,255,0.9);
                        display: none;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    }
                    
                    .loading-overlay.active {
                        display: flex;
                    }
                    
                    .spinner {
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #667eea;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        animation: spin 1s linear infinite;
                    }
                    
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    
                    .error-message {
                        background: #f44336;
                        color: white;
                        padding: 10px 15px;
                        border-radius: 5px;
                        margin: 10px;
                        display: none;
                    }
                    
                    .error-message.active {
                        display: block;
                    }
                </style>
            </t>
            
            <t t-set="head">
                <t t-raw="head_website"/>
            </t>
            
            <div class="history-container">
                <div class="history-header">
                    <h1 class="history-title">
                        <i class="fa fa-route"></i>
                        Device Route History
                    </h1>
                    
                    <div class="controls-panel">
                        <div class="control-group">
                            <label>Device</label>
                            <select id="device-select">
                                <option value="">Select Device...</option>
                                <t t-foreach="devices" t-as="device">
                                    <option t-att-value="device.id" 
                                            t-att-selected="'selected' if selected_device and device.id == selected_device.id else None"
                                            t-att-data-device-id="device.device_id">
                                        <t t-esc="device.name"/>
                                    </option>
                                </t>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>From Date &amp; Time</label>
                            <input type="datetime-local" id="from-datetime" />
                        </div>
                        
                        <div class="control-group">
                            <label>To Date &amp; Time</label>
                            <input type="datetime-local" id="to-datetime" />
                        </div>
                        
                        <div class="control-group">
                            <button class="btn-load" id="load-history" onclick="loadHistory()">
                                <i class="fa fa-search"></i> Load Route
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="error-message" id="error-message"></div>
                
                <div class="map-container">
                    <div id="history-map"></div>
                    
                    <div class="info-panel" id="info-panel" style="display: none;">
                        <h3>Route Summary</h3>
                        <div class="info-item">
                            <span class="info-label">Total Distance:</span>
                            <span class="info-value" id="total-distance">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Duration:</span>
                            <span class="info-value" id="duration">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Top Speed:</span>
                            <span class="info-value" id="top-speed">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Stops:</span>
                            <span class="info-value" id="stops-count">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Points:</span>
                            <span class="info-value" id="points-count">-</span>
                        </div>
                    </div>
                    
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <script type="text/javascript">
            //<![CDATA[
                let map;
                let routeLine;
                let markers = [];
                
                function initMap() {
                    map = new google.maps.Map(document.getElementById('history-map'), {
                        zoom: 6,
                        center: { lat: 24.7136, lng: 46.6753 },
                        mapTypeId: 'roadmap',
                        styles: [
                            {
                                featureType: 'poi',
                                elementType: 'labels',
                                stylers: [{ visibility: 'off' }]
                            }
                        ]
                    });
                }
                
                function setDefaultDateTimes() {
                    const now = new Date();
                    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    
                    const formatDateTime = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
                    };
                    
                    document.getElementById('from-datetime').value = formatDateTime(yesterday);
                    document.getElementById('to-datetime').value = formatDateTime(now);
                }
                
                function showError(message) {
                    const errorDiv = document.getElementById('error-message');
                    errorDiv.textContent = message;
                    errorDiv.classList.add('active');
                    
                    setTimeout(() => {
                        errorDiv.classList.remove('active');
                    }, 5000);
                }
                
                function showLoading(show) {
                    const overlay = document.getElementById('loading-overlay');
                    if (show) {
                        overlay.classList.add('active');
                    } else {
                        overlay.classList.remove('active');
                    }
                }
                
                function clearMap() {
                    if (routeLine) {
                        routeLine.setMap(null);
                    }
                    
                    markers.forEach(marker => marker.setMap(null));
                    markers = [];
                }
                
                function loadHistory() {
                    const deviceId = document.getElementById('device-select').value;
                    const fromDateTime = document.getElementById('from-datetime').value;
                    const toDateTime = document.getElementById('to-datetime').value;
                    
                    if (!deviceId) {
                        showError('Please select a device');
                        return;
                    }
                    
                    if (!fromDateTime || !toDateTime) {
                        showError('Please select date and time range');
                        return;
                    }
                    
                    const fromDT = fromDateTime.replace('T', ' ') + ':00';
                    const toDT = toDateTime.replace('T', ' ') + ':00';
                    
                    showLoading(true);
                    clearMap();
                    
                    odoo.define('device_history_loader', function(require) {
                        var ajax = require('web.ajax');
                        
                        ajax.jsonRpc('/idara_tracking/get_device_history', 'call', {
                            device_id: deviceId,
                            from_datetime: fromDT,
                            to_datetime: toDT
                        }).then(function(result) {
                            showLoading(false);
                            
                            if (result.status === 'error') {
                                showError('Error: ' + result.message);
                                return;
                            }
                            
                            if (result.status === 'success') {
                                displayRoute(result.data);
                            }
                        }).catch(function(error) {
                            showLoading(false);
                            showError('Failed to load history: ' + error.message);
                            console.error('Error:', error);
                        });
                    });
                }
                
                function displayRoute(historyData) {
                    if (!historyData || !historyData.items) {
                        showError('No route data available');
                        return;
                    }
                    
                    const routePoints = [];
                    let totalPoints = 0;
                    let stopsCount = 0;
                    
                    historyData.items.forEach(segment => {
                        if (segment.items && Array.isArray(segment.items)) {
                            segment.items.forEach(point => {
                                if (point.lat && point.lng) {
                                    routePoints.push({
                                        lat: parseFloat(point.lat),
                                        lng: parseFloat(point.lng),
                                        speed: parseFloat(point.speed) || 0,
                                        time: point.time,
                                        status: segment.status
                                    });
                                    totalPoints++;
                                }
                            });
                            
                            if (segment.status === 2) {
                                stopsCount++;
                            }
                        }
                    });
                    
                    if (routePoints.length === 0) {
                        showError('No GPS points found in the selected time range');
                        return;
                    }
                    
                    const path = routePoints.map(p => ({ lat: p.lat, lng: p.lng }));
                    
                    routeLine = new google.maps.Polyline({
                        path: path,
                        geodesic: true,
                        strokeColor: '#4285F4',
                        strokeOpacity: 0.8,
                        strokeWeight: 4,
                        map: map
                    });
                    
                    const startPoint = routePoints[0];
                    const startMarker = new google.maps.Marker({
                        position: { lat: startPoint.lat, lng: startPoint.lng },
                        map: map,
                        icon: {
                            url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                        },
                        title: 'Start: ' + startPoint.time
                    });
                    markers.push(startMarker);
                    
                    const endPoint = routePoints[routePoints.length - 1];
                    const endMarker = new google.maps.Marker({
                        position: { lat: endPoint.lat, lng: endPoint.lng },
                        map: map,
                        icon: {
                            url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                        },
                        title: 'End: ' + endPoint.time
                    });
                    markers.push(endMarker);
                    
                    const bounds = new google.maps.LatLngBounds();
                    routePoints.forEach(point => {
                        bounds.extend({ lat: point.lat, lng: point.lng });
                    });
                    map.fitBounds(bounds);
                    
                    document.getElementById('total-distance').textContent = historyData.distance_sum || '-';
                    document.getElementById('duration').textContent = historyData.move_duration || '-';
                    document.getElementById('top-speed').textContent = historyData.top_speed || '-';
                    document.getElementById('stops-count').textContent = stopsCount;
                    document.getElementById('points-count').textContent = totalPoints;
                    document.getElementById('info-panel').style.display = 'block';
                }
                
                document.addEventListener('DOMContentLoaded', function() {
                    initMap();
                    setDefaultDateTimes();
                });
            //]]>
            </script>
        </t>
    </template>
</odoo>
