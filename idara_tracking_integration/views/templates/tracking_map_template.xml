<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="tracking_map_template" name="Tracking Map">
        <t t-call="web.html_container">
            <t t-set="head">
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
                <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
                <style>
                    body { margin: 0; padding: 0; overflow: hidden; }
                    #header { background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 15px 20px; height: 70px; display: flex; align-items: center; justify-content: space-between; }
                    #map { height: calc(100vh - 70px); width: 100%; }
                    .device-count { background: #28a745; color: white; padding: 8px 15px; border-radius: 15px; font-weight: bold; }
                    .device-label { background: white; padding: 4px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; box-shadow: 0 1px 4px rgba(0,0,0,0.3); margin-top: -8px; }
                    .leaflet-marker-icon { transition: all 0.8s ease-in-out !important; }
                </style>
            </t>
            
            <div id="header">
                <div style="display:flex;align-items:center">
                    <img src="/idara_tracking_integration/static/src/img/logo.png" style="height:45px;margin-right:15px"/>
                    <span style="font-size:22px">üó∫Ô∏è Live Device Tracking</span>
                </div>
                <span class="device-count" id="device-count"><t t-esc="device_count or 0"/> Devices</span>
            </div>
            
            <div id="map"></div>
            
            <script>
            var devicesData = <t t-raw="devices"/>;
            var tzOff = parseInt('<t t-esc="timezone_offset or 3"/>');
            var refInt = parseInt('<t t-esc="refresh_interval"/>');
            
            var map, markers = {};
            
            function getCol(s) {
                return s === 'online' ? '#28a745' : s === 'moving' ? '#007bff' : s === 'idle' ? '#ffc107' : '#dc3545';
            }
            
            function getBdg(s) {
                return s === 'online' ? 'üü¢ Online' : s === 'moving' ? 'üîµ Moving' : s === 'idle' ? 'üü° Idle' : 'üî¥ Offline';
            }
            
            function adjTime(t) {
                if (!t) return 'N/A';
                try {
                    var d = new Date(t + 'Z');
                    d.setHours(d.getHours() + tzOff);
                    return d.toLocaleString();
                } catch(e) { return t; }
            }
            
            function init() {
                console.log('Init map, devices:', devicesData.length);
                
                if (typeof L === 'undefined') {
                    setTimeout(init, 500);
                    return;
                }
                
                map = L.map('map').setView([24.7136, 46.6753], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);
                
                var bds = L.latLngBounds();
                devicesData.forEach(function(d) {
                    var m = addMrk(d);
                    if (m) bds.extend(m.getLatLng());
                });
                
                if (devicesData.length > 0) {
                    map.fitBounds(bds, {padding: [50, 50]});
                }
                
                if (refInt > 0) {
                    setInterval(refr, refInt);
                }
            }
            
            function addMrk(d) {
                var la = parseFloat(d.latitude);
                var ln = parseFloat(d.longitude);
                if (!la || !ln) return null;
                
                var col = getCol(d.status);
                var nm = d.name || d.device_id || 'Unknown';
                
                var m = L.marker([la, ln], {
                    icon: L.divIcon({
                        className: '',
                        html: '<div style="position:relative"><div style="background:' + col + ';width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.4)"></div><div class="device-label">' + nm + '</div></div>',
                        iconSize: [120, 40],
                        iconAnchor: [60, 32]
                    })
                }).addTo(map);
                
                m.bindPopup(
                    '<div style="min-width:220px">' +
                    '<h3 style="margin:0 0 12px 0;color:#dc3545">üìç ' + nm + '</h3>' +
                    '<p style="margin:6px 0"><b>Device ID:</b> ' + (d.device_id || 'N/A') + '</p>' +
                    '<p style="margin:6px 0"><b>Status:</b> ' + getBdg(d.status) + '</p>' +
                    '<p style="margin:6px 0"><b>Speed:</b> ' + (d.speed || 0) + ' km/h</p>' +
                    '<p style="margin:6px 0"><b>Driver:</b> ' + (d.driver_name || 'N/A') + '</p>' +
                    '<p style="margin:6px 0"><b>Vehicle:</b> ' + (d.vehicle_id || 'N/A') + '</p>' +
                    '<p style="margin:6px 0"><b>Location:</b> ' + (d.address || 'Unknown') + '</p>' +
                    '<p style="margin:6px 0;font-size:11px;color:#666">Last: ' + adjTime(d.last_update) + '</p>' +
                    '</div>'
                );
                
                markers[d.id] = m;
                return m;
            }
            
            function refr() {
                fetch('/idara_tracking/devices/json', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({jsonrpc: '2.0', method: 'call', params: {}, id: Date.now()})
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var dvs = data.result;
                    if (!dvs || !Array.isArray(dvs)) return;
                    
                    document.getElementById('device-count').textContent = dvs.length + ' Devices';
                    
                    dvs.forEach(function(d) {
                        var m = markers[d.id];
                        if (m) {
                            m.setLatLng([parseFloat(d.latitude), parseFloat(d.longitude)]);
                            var col = getCol(d.status);
                            var nm = d.name || d.device_id || 'Unknown';
                            m.setIcon(L.divIcon({
                                className: '',
                                html: '<div style="position:relative"><div style="background:' + col + ';width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.4)"></div><div class="device-label">' + nm + '</div></div>',
                                iconSize: [120, 40],
                                iconAnchor: [60, 32]
                            }));
                        } else {
                            addMrk(d);
                        }
                    });
                });
            }
            
            setTimeout(init, 100);
            </script>
        </t>
    </template>
</odoo>
