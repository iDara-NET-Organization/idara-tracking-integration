<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="tracking_map_template" name="Tracking Map">
        <t t-call="web.html_container">
            <div class="container-fluid" style="padding: 0; margin: 0;">
                <style>
                    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
                    #header {
                        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                        color: white;
                        padding: 15px 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    }
                    .header-left { display: flex; align-items: center; }
                    #header img { height: 45px; margin-right: 15px; }
                    #header h1 { margin: 0; font-size: 22px; }
                    .btn-refresh {
                        background: rgba(255,255,255,0.2);
                        color: white;
                        border: 1px solid rgba(255,255,255,0.3);
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                    }
                    .device-count {
                        background: #28a745;
                        color: white;
                        padding: 5px 15px;
                        border-radius: 15px;
                        font-weight: bold;
                    }
                    #map { height: calc(100vh - 80px); width: 100%; }
                    
                    /* Device label styles */
                    .device-label {
                        background: white;
                        padding: 4px 8px;
                        border-radius: 3px;
                        font-size: 11px;
                        font-weight: bold;
                        white-space: nowrap;
                        box-shadow: 0 1px 4px rgba(0,0,0,0.3);
                        border: 1px solid #ddd;
                        margin-top: -8px;
                        text-align: center;
                    }
                    
                    /* Smooth marker transition */
                    .leaflet-marker-icon {
                        transition: all 0.8s ease-in-out !important;
                    }
                </style>

                <div id="header">
                    <div class="header-left">
                        <img src="/idara_tracking_integration/static/src/img/logo.png" alt="Idara Tracking"/>
                        <h1>üó∫Ô∏è Live Device Tracking</h1>
                    </div>
                    <div>
                        <span class="device-count" id="device-count"><t t-esc="device_count"/> Devices</span>
                    </div>
                </div>

                <div id="map"></div>

                <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

                <script>
                    const initialDevices = <t t-raw="devices"/>;
                    console.log('Initial devices loaded:', initialDevices.length);
                    
                    // Initialize map
                    const map = L.map('map').setView([24.7136, 46.6753], 6);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap',
                        maxZoom: 19
                    }).addTo(map);

                    // Store markers by device ID for smooth updates
                    const deviceMarkers = {};
                    
                    function getMarkerColor(status) {
                        const colors = {
                            'online': '#28a745',
                            'moving': '#007bff',
                            'idle': '#ffc107',
                            'offline': '#dc3545'
                        };
                        return colors[status] || '#dc3545';
                    }
                    
                    function getStatusBadge(status) {
                        const badges = {
                            'online': 'üü¢ Online',
                            'moving': 'üîµ Moving',
                            'idle': 'üü° Idle',
                            'offline': 'üî¥ Offline'
                        };
                        return badges[status] || 'üî¥ Offline';
                    }
                    
                    function createDeviceMarker(device) {
                        const lat = parseFloat(device.latitude);
                        const lng = parseFloat(device.longitude);
                        
                        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                            console.warn('Invalid coordinates for device:', device.name);
                            return null;
                        }
                        
                        const color = getMarkerColor(device.status);
                        const deviceName = device.name || device.device_id || 'Unknown';
                        
                        // Create marker with label
                        const marker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `
                                    <div style="position: relative;">
                                        <div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"></div>
                                        <div class="device-label">${deviceName}</div>
                                    </div>
                                `,
                                iconSize: [120, 40],
                                iconAnchor: [60, 32]
                            })
                        }).addTo(map);
                        
                        // Bind popup
                        marker.bindPopup(`
                            <div style="min-width: 220px; font-family: Arial;">
                                <h3 style="margin: 0 0 12px 0; color: #dc3545; font-size: 16px;">üìç ${deviceName}</h3>
                                <p style="margin: 6px 0; font-size: 13px;"><strong>Device ID:</strong> ${device.device_id || 'N/A'}</p>
                                <p style="margin: 6px 0; font-size: 13px;"><strong>Status:</strong> ${getStatusBadge(device.status)}</p>
                                <p style="margin: 6px 0; font-size: 13px;"><strong>Speed:</strong> ${device.speed || 0} km/h</p>
                                <p style="margin: 6px 0; font-size: 13px;"><strong>Driver:</strong> ${device.driver_name || 'N/A'}</p>
                                <p style="margin: 6px 0; font-size: 13px;"><strong>Vehicle:</strong> ${device.vehicle_id || 'N/A'}</p>
                                <p style="margin: 6px 0; font-size: 13px;"><strong>Location:</strong> ${device.address || 'Unknown'}</p>
                                <p style="margin: 6px 0; font-size: 11px; color: #666;">Last update: ${device.last_update || 'N/A'}</p>
                            </div>
                        `);
                        
                        return marker;
                    }
                    
                    function updateDeviceMarker(device) {
                        const lat = parseFloat(device.latitude);
                        const lng = parseFloat(device.longitude);
                        
                        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                            return;
                        }
                        
                        const deviceKey = device.id.toString();
                        const existingMarker = deviceMarkers[deviceKey];
                        
                        if (existingMarker) {
                            // Update existing marker - smooth movement
                            const newLatLng = L.latLng(lat, lng);
                            const oldLatLng = existingMarker.getLatLng();
                            
                            // Only update if position changed
                            if (oldLatLng.lat !== newLatLng.lat || oldLatLng.lng !== newLatLng.lng) {
                                existingMarker.setLatLng(newLatLng);
                            }
                            
                            // Update marker icon and label
                            const color = getMarkerColor(device.status);
                            const deviceName = device.name || device.device_id || 'Unknown';
                            
                            existingMarker.setIcon(L.divIcon({
                                className: 'custom-marker',
                                html: `
                                    <div style="position: relative;">
                                        <div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"></div>
                                        <div class="device-label">${deviceName}</div>
                                    </div>
                                `,
                                iconSize: [120, 40],
                                iconAnchor: [60, 32]
                            }));
                            
                            // Update popup content
                            existingMarker.setPopupContent(`
                                <div style="min-width: 220px; font-family: Arial;">
                                    <h3 style="margin: 0 0 12px 0; color: #dc3545; font-size: 16px;">üìç ${deviceName}</h3>
                                    <p style="margin: 6px 0; font-size: 13px;"><strong>Device ID:</strong> ${device.device_id || 'N/A'}</p>
                                    <p style="margin: 6px 0; font-size: 13px;"><strong>Status:</strong> ${getStatusBadge(device.status)}</p>
                                    <p style="margin: 6px 0; font-size: 13px;"><strong>Speed:</strong> ${device.speed || 0} km/h</p>
                                    <p style="margin: 6px 0; font-size: 13px;"><strong>Driver:</strong> ${device.driver_name || 'N/A'}</p>
                                    <p style="margin: 6px 0; font-size: 13px;"><strong>Vehicle:</strong> ${device.vehicle_id || 'N/A'}</p>
                                    <p style="margin: 6px 0; font-size: 13px;"><strong>Location:</strong> ${device.address || 'Unknown'}</p>
                                    <p style="margin: 6px 0; font-size: 11px; color: #666;">Last update: ${device.last_update || 'N/A'}</p>
                                </div>
                            `);
                        } else {
                            // Create new marker
                            const marker = createDeviceMarker(device);
                            if (marker) {
                                deviceMarkers[deviceKey] = marker;
                            }
                        }
                    }
                    
                    function refreshDevices() {
                        console.log('Fetching updated device positions...');
                        
                        // Use fetch API
                        fetch('/idara_tracking/devices/json', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'call',
                                params: {},
                                id: new Date().getTime()
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            const devices = data.result;
                            console.log('Received', devices.length, 'device updates');
                            
                            // Update device count
                            document.getElementById('device-count').textContent = devices.length + ' Devices';
                            
                            // Update each device marker
                            devices.forEach(device => {
                                updateDeviceMarker(device);
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching devices:', error);
                        });
                    }
                    
                    // Initialize map with devices
                    const bounds = L.latLngBounds();
                    let markersAdded = 0;
                    
                    initialDevices.forEach(device => {
                        const marker = createDeviceMarker(device);
                        if (marker) {
                            deviceMarkers[device.id.toString()] = marker;
                            bounds.extend(marker.getLatLng());
                            markersAdded++;
                        }
                    });
                    
                    console.log('Total markers added:', markersAdded);
                    
                    if (markersAdded > 0) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    } else {
                        console.warn('No valid devices to display on map');
                    }
                    
                    // Auto-refresh based on configuration
                    const refreshInterval = <t t-esc="refresh_interval"/>;
                    console.log(`Auto-refresh enabled: every ${refreshInterval / 1000} seconds`);
                    
                    if (refreshInterval > 0) {
                        setInterval(refreshDevices, refreshInterval);
                    }
                </script>
            </div>
        </t>
    </template>
</odoo>
