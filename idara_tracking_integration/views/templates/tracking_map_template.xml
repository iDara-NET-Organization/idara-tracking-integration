<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="tracking_map_template" name="Tracking Map">
        <t t-call="web.html_container">
            <div class="container-fluid" style="padding: 0; margin: 0;">
                <style>
                    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
                    #header {
                        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                        color: white;
                        padding: 15px 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    }
                    .header-left { display: flex; align-items: center; }
                    #header img { height: 45px; margin-right: 15px; }
                    #header h1 { margin: 0; font-size: 22px; }
                    .btn-refresh {
                        background: rgba(255,255,255,0.2);
                        color: white;
                        border: 1px solid rgba(255,255,255,0.3);
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                    }
                    .device-count {
                        background: #28a745;
                        color: white;
                        padding: 5px 15px;
                        border-radius: 15px;
                        font-weight: bold;
                    }
                    #map { height: calc(100vh - 80px); width: 100%; }
                </style>

                <div id="header">
                    <div class="header-left">
                        <img src="/idara_tracking_integration/static/src/img/logo.png" alt="Idara Tracking"/>
                        <h1>üó∫Ô∏è Live Device Tracking</h1>
                    </div>
                    <div>
                        <span class="device-count"><t t-esc="device_count"/> Devices</span>
                    </div>
                </div>

                <div id="map"></div>

                <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

                <script>
                    const devicesData = <t t-raw="devices"/>;
                    console.log('Loaded devices:', devicesData);
                    
                    // Initialize map
                    const map = L.map('map').setView([24.7136, 46.6753], 6);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap',
                        maxZoom: 19
                    }).addTo(map);

                    // Add device markers
                    const bounds = L.latLngBounds();
                    let markersAdded = 0;
                    
                    devicesData.forEach(device => {
                        const lat = parseFloat(device.latitude);
                        const lng = parseFloat(device.longitude);
                        
                        console.log('Processing device:', device.name, 'lat:', lat, 'lng:', lng);
                        
                        if (lat &amp;&amp; lng &amp;&amp; !isNaN(lat) &amp;&amp; !isNaN(lng)) {
                            const color = device.status === 'online' ? '#28a745' : 
                                         device.status === 'moving' ? '#007bff' :
                                         device.status === 'idle' ? '#ffc107' : '#dc3545';
                            
                            const marker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'custom-marker',
                                    html: `&lt;div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"&gt;&lt;/div&gt;`,
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                })
                            }).addTo(map);
                            
                            const statusBadge = device.status === 'online' ? 'üü¢ Online' :
                                               device.status === 'moving' ? 'üîµ Moving' :
                                               device.status === 'idle' ? 'üü° Idle' : 'üî¥ Offline';
                            
                            marker.bindPopup(`
                                &lt;div style="min-width: 220px; font-family: Arial;"&gt;
                                    &lt;h3 style="margin: 0 0 12px 0; color: #dc3545; font-size: 16px;"&gt;üìç ${device.name}&lt;/h3&gt;
                                    &lt;p style="margin: 6px 0; font-size: 13px;"&gt;&lt;strong&gt;Device ID:&lt;/strong&gt; ${device.device_id}&lt;/p&gt;
                                    &lt;p style="margin: 6px 0; font-size: 13px;"&gt;&lt;strong&gt;Status:&lt;/strong&gt; ${statusBadge}&lt;/p&gt;
                                    &lt;p style="margin: 6px 0; font-size: 13px;"&gt;&lt;strong&gt;Speed:&lt;/strong&gt; ${device.speed} km/h&lt;/p&gt;
                                    &lt;p style="margin: 6px 0; font-size: 13px;"&gt;&lt;strong&gt;Driver:&lt;/strong&gt; ${device.driver_name || 'N/A'}&lt;/p&gt;
                                    &lt;p style="margin: 6px 0; font-size: 13px;"&gt;&lt;strong&gt;Vehicle:&lt;/strong&gt; ${device.vehicle_id || 'N/A'}&lt;/p&gt;
                                    &lt;p style="margin: 6px 0; font-size: 13px;"&gt;&lt;strong&gt;Location:&lt;/strong&gt; ${device.address || 'Unknown'}&lt;/p&gt;
                                    &lt;p style="margin: 6px 0; font-size: 11px; color: #666;"&gt;Last update: ${device.last_update || 'N/A'}&lt;/p&gt;
                                &lt;/div&gt;
                            `);
                            
                            bounds.extend([lat, lng]);
                            markersAdded++;
                        } else {
                            console.warn('Invalid coordinates for device:', device.name);
                        }
                    });
                    
                    console.log('Total markers added:', markersAdded);
                    
                    if (markersAdded > 0) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    } else {
                        console.warn('No valid devices to display on map');
                    }
                    
                    // Auto-refresh based on configuration
                    const refreshInterval = <t t-esc="refresh_interval"/>;
                    console.log(`Auto-refresh enabled: every ${refreshInterval / 1000} seconds`);
                    
                    if (refreshInterval > 0) {
                        setInterval(() => {
                            console.log('Auto-refreshing device locations...');
                            location.reload();
                        }, refreshInterval);
                    }
                </script>
            </div>
        </t>
    </template>
</odoo>
